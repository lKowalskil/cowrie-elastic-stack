input {
    beats {
        port => 5044
    }
}

filter {
    # Добавляем поле обработки чтобы избежать смешивания логов
    mutate {
        add_field => { "[@metadata][processed]" => false }
    }
    
    # Обработка логов Heralding
    if [honeypot] == "heralding" and [tags] and "heralding" in [tags] {
        # Убедимся, что мы не обрабатываем лог дважды
        if [@metadata][processed] == false {
            mutate {
                update => { "[@metadata][processed]" => true }
            }
            
            if [log_type] == "session_json" {
                json {
                    source => "message"
                }
                date {
                    match => [ "timestamp", "yyyy-MM-dd HH:mm:ss.SSSSSS" ]
                    target => "@timestamp"
                }
            } else if [log_type] == "auth_csv" {
                csv {
                    separator => ","
                    columns => ["timestamp", "auth_id", "session_id", "source_ip", "source_port", "destination_ip", "destination_port", "protocol", "username", "password", "password_hash"]
                }
                date {
                    match => [ "timestamp", "yyyy-MM-dd HH:mm:ss.SSSSSS" ]
                    target => "@timestamp"
                }
            } else if [log_type] == "session_csv" {
                csv {
                    separator => ","
                    columns => ["timestamp", "duration", "session_id", "source_ip", "source_port", "destination_ip", "destination_port", "protocol", "num_auth_attempts"]
                }
                date {
                    match => [ "timestamp", "yyyy-MM-dd HH:mm:ss.SSSSSS" ]
                    target => "@timestamp"
                }
            }
            
            mutate {
                add_field => { "event_source" => "heralding" }
                remove_field => ["@version", "input", "log"]
            }
        }
    }
    
    # Обработка логов Cowrie
    else if [honeypot] == "cowrie" and [tags] and "cowrie" in [tags] {
        # Убедимся, что мы не обрабатываем лог дважды
        if [@metadata][processed] == false {
            mutate {
                update => { "[@metadata][processed]" => true }
            }
            
            json {
                source => "message"
            }
            
            if [timestamp] {
                date {
                    match => [ "timestamp", "ISO8601" ]
                    target => "@timestamp"
                }
            }
            
            # Корректируем типы полей
            mutate {
                convert => {
                    "duration" => "float"
                    "src_port" => "integer"
                    "dst_port" => "integer"
                }
                add_field => { "event_source" => "cowrie" }
                remove_field => ["@version", "input", "log"]
            }
        }
    }
}

output {
    # Отладочный вывод (раскомментировать при необходимости)
    # stdout { codec => rubydebug }
    
    # Разделяем выводы логов по разным индексам
    if [honeypot] == "heralding" and [event_source] == "heralding" {
        elasticsearch {
            hosts => ["elasticsearch:9200"]
            index => "heralding-%{+YYYY.MM.dd}"
        }
    }
    else if [honeypot] == "cowrie" and [event_source] == "cowrie" {
        elasticsearch {
            hosts => ["elasticsearch:9200"]
            index => "cowrie-%{+YYYY.MM.dd}"
        }
    }
}
